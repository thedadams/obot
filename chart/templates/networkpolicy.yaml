{{- if and (eq .Values.config.OBOT_SERVER_MCPRUNTIME_BACKEND "kubernetes") .Values.mcpNamespace.networkPolicy.enabled }}
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: mcp-egress-restrictions
  namespace: {{ include "obot.config.mcpNamespace" . }}
  labels:
    {{- include "obot.labels" . | nindent 4 }}
spec:
  podSelector: {}
  policyTypes:
    - Egress
    - Ingress
  # Allow ingress only from Obot pods
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
          podSelector:
            matchLabels:
              {{- include "obot.selectorLabels" . | nindent 14 }}
  egress:
    # Allow DNS lookups to DNS namespace
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Values.mcpNamespace.networkPolicy.dnsNamespace }}
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
    # Allow communication to Obot service
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
          podSelector:
            matchLabels:
              {{- include "obot.selectorLabels" . | nindent 14 }}
      ports:
        - protocol: TCP
          port: 8080
    # Allow egress to all public IP ranges (block private/reserved ranges)
    - to:
        # Block private IPv4 ranges by allowing everything except:
        # 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16, 127.0.0.0/8, 169.254.0.0/16, 224.0.0.0/4, 240.0.0.0/4
        - ipBlock:
            cidr: 0.0.0.0/0
            except:
              - 10.0.0.0/8       # Private network
              - 172.16.0.0/12    # Private network
              - 192.168.0.0/16   # Private network
              - 127.0.0.0/8      # Loopback
              - 169.254.0.0/16   # Link-local
              - 224.0.0.0/4      # Multicast
              - 240.0.0.0/4      # Reserved
{{- end }}
